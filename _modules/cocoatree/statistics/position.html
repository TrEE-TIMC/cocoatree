<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cocoatree.statistics.position &#8212; cocoatree 0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d7e2fa82" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nameko.css?v=2296cfae" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script src="../../../_static/documentation_options.js?v=837179f8"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Lora:400' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  </head><body><div class="navbar related">
      <a href="../../../index.html">
        
      </a>
    <ul class="nav nav-pills nav-stacked">
      <li class="right"><a href="../../../auto_examples/index.html">Gallery</a> </li>
      <li class="right"><a href="../../../modules/classes.html">API</a> | </li>
      <li class="right"><a href="../../../install.html">Installation</a> | </li>
      <li class="right"><a href="../../../index.html">Home</a> | </li>
      
    </ul>
  </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cocoatree.statistics.position</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..__params</span><span class="w"> </span><span class="kn">import</span> <span class="n">lett2num</span><span class="p">,</span> <span class="n">__freq_regularization_ref</span><span class="p">,</span> <span class="n">__aa_count</span><span class="p">,</span> <span class="n">__freq0</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..msa</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_seq_weights</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_aa_freqs</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">seq_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">freq_regul</span><span class="o">=</span><span class="n">__freq_regularization_ref</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes frequencies of amino acids at each position of the alignment.</span>

<span class="sd">    .. math::</span>
<span class="sd">        f_i^a = (\\sum_s w_s x_{si}^a + \\lambda/21)/(M_{eff} + \\lambda)</span>

<span class="sd">    where</span>

<span class="sd">    .. math::</span>

<span class="sd">        M_{eff} = \\sum_s w_s</span>

<span class="sd">    represents the effective number of sequences in the alignment and *lambda*</span>
<span class="sd">    is a regularization parameter (pseudocount).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sequences : list of sequences as imported by load_msa()</span>

<span class="sd">    seq_weights : numpy 1D array, optional</span>
<span class="sd">            Gives more or less importance to certain sequences. If</span>
<span class="sd">            seq_weights=None, all sequences are attributed an equal weight</span>
<span class="sd">            of 1.</span>

<span class="sd">    freq_regul : regularization parameter (default=__freq_regularization_ref)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aa_freq : np.ndarray of shape (Npos, aa_count)</span>
<span class="sd">            frequency of amino acid *a* at position *i*</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">char</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">])</span>
    <span class="n">binary_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">aa</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">lett2num</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># weights</span>
    <span class="k">if</span> <span class="n">seq_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seq_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">))</span>
    <span class="n">m_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">seq_weights</span><span class="p">)</span>
    <span class="n">weighted_binary_array</span> <span class="o">=</span> \
        <span class="n">binary_array</span> <span class="o">*</span> <span class="n">seq_weights</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">aa_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_binary_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
               <span class="o">+</span> <span class="n">freq_regul</span> <span class="o">*</span> <span class="n">m_eff</span> <span class="o">/</span> <span class="n">__aa_count</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">freq_regul</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_eff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aa_freq</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_background_freqs</span><span class="p">(</span><span class="n">aa_freqs</span><span class="p">,</span> <span class="n">sequences</span><span class="p">,</span> <span class="n">seq_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">freq_regul</span><span class="o">=</span><span class="n">__freq_regularization_ref</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes (regularized) background frequencies of amino acids</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aa_freqs : np.ndarray of the positional amino acid frequencies</span>

<span class="sd">    sequences : list of sequences for which seq_weights give weights</span>

<span class="sd">    seq_weights : numpy 1D array, optional</span>
<span class="sd">            Gives more or less importance to certain sequences.</span>
<span class="sd">            If seq_weights=None, all sequences are attributed an equal weight</span>
<span class="sd">            of 1.</span>

<span class="sd">    freq_regul : regularization parameter (default=__freq_regularization_ref)</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bkgd_freqs :  np.ndarray (21, )</span>
<span class="sd">        A (21,) np.array containing the background amino acid frequencies</span>
<span class="sd">        at each position; it is computed from the mean frequency of amino acid</span>
<span class="sd">        *a* in all proteins in the NCBI non-redundant database</span>
<span class="sd">        (see Rivoire et al., https://dx.plos.org/10.1371/journal.pcbi.1004817)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># q0 : fraction of gaps in the alignment</span>
    <span class="n">q0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aa_freqs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1"># background_freq : correction factor on __freq0 in order to take the</span>
    <span class="c1"># proportion of gaps into account</span>
    <span class="n">bkgd_freqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">q0</span><span class="p">)</span> <span class="o">*</span> <span class="n">__freq0</span><span class="p">)</span>
    <span class="n">bkgd_freqs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q0</span><span class="p">)</span>
    <span class="n">bkgd_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkgd_freqs</span><span class="p">)</span>

    <span class="c1"># weights</span>
    <span class="k">if</span> <span class="n">seq_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seq_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">))</span>
    <span class="n">m_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">seq_weights</span><span class="p">)</span>

    <span class="c1"># regularization</span>
    <span class="n">bkgd_freqs</span> <span class="o">=</span> <span class="p">(</span><span class="n">bkgd_freqs</span> <span class="o">*</span> <span class="n">m_eff</span> <span class="o">+</span>
                  <span class="n">freq_regul</span> <span class="o">*</span> <span class="n">m_eff</span> <span class="o">/</span> <span class="n">__aa_count</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">freq_regul</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_eff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bkgd_freqs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_first_order_freqs</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">seq_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">freq_regul</span><span class="o">=</span><span class="n">__freq_regularization_ref</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute amino acid frequencies at each position and background frequencies</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sequences : list of sequences for which seq_weights gives weights</span>

<span class="sd">    seq_weights : numpy 1D array, optional, default=None</span>
<span class="sd">        Gives more or less importance to certain sequences.</span>
<span class="sd">        If seq_weights=None, will compute sequence weights</span>

<span class="sd">    freq_regul : regularization parameter (default=__freq_regularization_ref)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aa_freqs : np.ndarray of the positional amino acid frequencies</span>

<span class="sd">    bkgd_freqs : np.ndarray (21, )</span>
<span class="sd">    A (21, ) np.array containing the background amino acid frequencies at each</span>
<span class="sd">    position. It is computed from the mean frequency of amino acid *a* in all</span>
<span class="sd">    proteins in the NCBI non-redundant database.</span>

<span class="sd">    (see Rivoire et al., https://dx.plos.org/10.1371/journal.pcbi.1004817)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">seq_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">seq_weights</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_seq_weights</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>

    <span class="n">aa_freqs</span> <span class="o">=</span> <span class="n">_compute_aa_freqs</span><span class="p">(</span>
        <span class="n">sequences</span><span class="p">,</span>
        <span class="n">freq_regul</span><span class="o">=</span><span class="n">freq_regul</span><span class="p">,</span>
        <span class="n">seq_weights</span><span class="o">=</span><span class="n">seq_weights</span><span class="p">)</span>

    <span class="n">bkgd_freqs</span> <span class="o">=</span> <span class="n">_compute_background_freqs</span><span class="p">(</span>
        <span class="n">aa_freqs</span><span class="p">,</span>
        <span class="n">sequences</span><span class="p">,</span>
        <span class="n">seq_weights</span><span class="o">=</span><span class="n">seq_weights</span><span class="p">,</span>
        <span class="n">freq_regul</span><span class="o">=</span><span class="n">__freq_regularization_ref</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aa_freqs</span><span class="p">,</span> <span class="n">bkgd_freqs</span>


<div class="viewcode-block" id="compute_entropy">
<a class="viewcode-back" href="../../../modules/generated/cocoatree.statistics.position.compute_entropy.html#cocoatree.statistics.position.compute_entropy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_entropy</span><span class="p">(</span><span class="n">aa_freq</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes  Shannon&#39;s entropy for each position in the alignment</span>

<span class="sd">    .. math::</span>

<span class="sd">        H(a) = -\\sum_i f_{ia} \\log f_{ia}</span>

<span class="sd">    where *H(a)* is the relative entropy of amino acid *a*,</span>
<span class="sd">        *fia* is the frequency of amino acid *a* at position *i*</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aa_freq : np.ndarray,</span>
<span class="sd">        amino acid frequencies per position</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s: array of shape (N_pos)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">aa_freq</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aa_freq</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span></div>



<div class="viewcode-block" id="compute_conservation">
<a class="viewcode-back" href="../../../modules/generated/cocoatree.statistics.position.compute_conservation.html#cocoatree.statistics.position.compute_conservation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_conservation</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">seq_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">freq_regul</span><span class="o">=</span><span class="n">__freq_regularization_ref</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the conservation of amino acid at each position.</span>

<span class="sd">    The conservation is computed as the relative entropy (e.g., the</span>
<span class="sd">    Kullback-Leibler divergence)</span>

<span class="sd">    .. math::</span>

<span class="sd">        D_i^a = f_i^a \\ln \\frac{f_i^a}{q^a} + (1 - f_i^a) \\ln \</span>
<span class="sd">            \\frac{1 - f_i^a}{1 - q^a}</span>

<span class="sd">    where :math:`f_i^a` is the observed frequency of amino acid `a` at</span>
<span class="sd">        position i`, :math:`q^a` is the background expectation</span>

<span class="sd">    :math:`D_i^a` indicates how unlikely the observed frequencies of amino</span>
<span class="sd">    acid `a` at position `i` would be if `a` occurred randomly with</span>
<span class="sd">    probability :math:`q^a`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sequences : list of sequences</span>

<span class="sd">    seq_weights : ndarray (nseq), optional, default: None</span>
<span class="sd">        if None, will compute sequence weights</span>

<span class="sd">    freq_regul : regularization parameter (default=__freq_regularization_ref)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Di : np.ndarray (npos,)</span>
<span class="sd">        where each entry corresponds to the conservation at this position in</span>
<span class="sd">        the sequences.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">aa_freqs</span><span class="p">,</span> <span class="n">bkgd_freqs</span> <span class="o">=</span> <span class="n">_compute_first_order_freqs</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">seq_weights</span><span class="p">,</span>
                                                      <span class="n">freq_regul</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">Di</span> <span class="o">=</span> <span class="n">_compute_rel_entropy</span><span class="p">(</span><span class="n">aa_freqs</span><span class="p">,</span> <span class="n">bkgd_freqs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Di</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_compute_rel_entropy</span><span class="p">(</span><span class="n">aa_freqs</span><span class="p">,</span> <span class="n">bkgd_freqs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the relative entropy</span>

<span class="sd">    Also know as the Kullback-Leibler divergence</span>

<span class="sd">    .. math::</span>

<span class="sd">        D_i^a = f_i^a \\ln \\frac{f_i^a}{q^a} + (1 - f_i^a) \\ln \</span>
<span class="sd">            \\frac{1 - f_i^a}{1 - q^a}</span>

<span class="sd">    where f_i^a is the observed frequency of amino acid *a* at position *i*,</span>
<span class="sd">        q^a is the background expectation</span>

<span class="sd">    D_i^a is known as the Kullback-Leibler relative entropy (Cover and Thomas,</span>
<span class="sd">    2012) and indicates how unlikely the observed frequencies of amino acid</span>
<span class="sd">    *a* at position *i* would be if *a* occurred randomly with probability q^a.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aa_freqs: np.ndarray,</span>
<span class="sd">        amino acid frequencies per position</span>

<span class="sd">    bck_freq: np.ndarray,</span>
<span class="sd">        background frequenvies of amino acids</span>

<span class="sd">    returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dia: np.ndarray,</span>
<span class="sd">        relative entropy of aa_freq given the background distribution of amino</span>
<span class="sd">        acids. Indicates how unlikely the observed frequency of amino acid *a*</span>
<span class="sd">        at position *i* would be if a occurred randomly with probability</span>
<span class="sd">        background_freq</span>

<span class="sd">    Di: np.ndarray,</span>
<span class="sd">        overall conservation of position *i* taking all amino acids into</span>
<span class="sd">        account</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Dia</span> <span class="o">=</span> <span class="n">aa_freqs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aa_freqs</span> <span class="o">/</span> <span class="n">bkgd_freqs</span><span class="p">)</span> <span class="o">+</span> \
        <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">aa_freqs</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">aa_freqs</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">bkgd_freqs</span><span class="p">))</span>

    <span class="c1"># sum on all amino acid at each position</span>
    <span class="n">Di</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">aa_freqs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">aa_freqs</span> <span class="o">/</span> <span class="n">bkgd_freqs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Dia</span><span class="p">,</span> <span class="n">Di</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>